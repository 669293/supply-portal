{# templates/bills/print.html.twig #}
{% extends 'default.html.twig' %}

{# Заголовки #}
{% block title %}{{ title }}{% endblock %}
{% block caption %}{{ title }}{% endblock %}

{# Панель навигации вверху #}
{% block nav %}
        <nav class="navbar navbar-expand-md navbar-light">
          <div class="container-fluid px-0 mb-1">
              <form class="d-flex w-100" method="GET" action="/applications/bills/search">
                <div class="input-group input-group-sm mt-2">
                  <input type="text" class="form-control" placeholder="Поиск по счетам" aria-label="Поиск по счетам" name="q" />
                  <button class="btn btn-outline-secondary button-search" type="button" onClick="$(this).closest('form').submit();"><i class="bi bi-search"></i></button>
                </div>
              </form>
          </div>
        </nav>
{% endblock %}

{# Контент #}
{% block content %}
    {% if bills|length > 0 %}
        <fieldset>
            <input type="hidden" name="token" value="{{ csrf_token('download-bills') }}"/>
            <div class="container-fluid w-100 px-0 overflow-scroll mt-0 mb-1 pb-3">
                <table class="table table-sm table-hover table-bordered table-striped mb-0 us-none" id="billsTable">
                    <thead>
                        <tr>
                            <th class="py-2 align-middle text-center text-small" scope="col" style="width: 40px;">№</th>
                            <th class="py-2 align-middle text-small" scope="col">Заявка</th>
                            <th class="py-2 align-middle text-small" scope="col">Отправитель<br />Ответственный</th>
                            <th class="py-2 align-middle text-small" scope="col">Поставщик</th>
                            <th class="py-2 align-middle text-small" scope="col">Сумма<br />Срочность</th>
                            <th class="py-2 align-middle text-small" scope="col">Комментарии</th>
                            <th class="py-2 align-middle text-small w-auto" scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% set fileId = 0 %}
                    {% for bill in bills %}
                        <tr>
                            <td class="align-middle text-center text-small">{{ loop.index }}</td>
                            <td class="align-top text-small text-nowrap">
                            {% for application in bill.applications %}
                                {% if loop.index > 1 %}<br />{% endif %}<a href="/applications/bills/in-work/view/?id={{ bill.obj.getId }}">{{ application.getTitle }}</a> <span class="text-muted text-small">№{{ application.getId }} от {{ application.getDateCreate|date('d.m.Y') }}</span>
                            {% endfor %}
                            </td>
                            <td class="align-middle text-xsmall text-nowrap">
                                {% for application in bill.applications %}{% if loop.index > 1 %}<br />{% endif %}{{ application.getAuthor.getShortUsername }}{% endfor %}
                                <hr class="mt-1 mb-1" style="border-color: #dee2e6; background: #dee2e6; opacity: 1;" />{{ bill.obj.getUser.getShortUsername }}
                            </td>
                            <td class="align-top text-small text-nowrap">
                                <table>
                                    <tbody>
                                        {% if bill.provider != null and bill.provider.getTitle != '' %}
                                            <tr>
                                                <td class="text-muted pe-2">Наименование:</td>
                                                <td>{{ bill.provider.getTitle }}</td>
                                            </tr>
                                        {% endif %}
                                        <tr>
                                            <td class="text-muted pe-2">ИНН:</td>
                                            <td>{{ bill.obj.getInn }}</td>
                                        </tr>
                                        {% if bill.provider != null and bill.provider.getPhone != '' %}
                                            <tr>
                                                <td class="text-muted pe-2">Телефон:</td>
                                                <td>{{ bill.provider.getPhone }}</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </td>
                            <td class="align-middle text-xsmall text-nowrap">
                                {{ bill.obj.sum|number_format(2, '.', ' ') }} {{ bill.obj.currency }}
                                {% if bill.urgency %}<br /><i class="bi bi-exclamation-triangle text-danger"></i> <span class="text-danger">Срочно</span>{% endif %}
                            </td>
                            <td class="align-middle text-xsmall fs-8 align-justify" style="max-width: 300px!important;">
                                {% if bill.obj.getNote != '' %}
                                    {{ bill.obj.getNote }}
                                {% else %}
                                    <span class="text-muted">Нет комментариев</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center text-nowrap">
                                <a class="kv-file-download btn btn-sm btn-kv btn-default btn-outline-success" title="Распечатать на подпись" href="/applications/bills/download?id={{ bill.id }}" target="_blank"><i class="bi-printer"></i></a>
                                <a class="kv-file-download btn btn-sm btn-kv btn-default btn-outline-secondary filePreview" data-id="thumb-attachments-init-{{ fileId }}" title="Просмотр" href="#?" target="_blank"><i class="bi-zoom-in"></i></a>
                                <a class="kv-file-download btn btn-sm btn-kv btn-default btn-outline-secondary" title="Скачать файл" href="/upload/bills/{{ bill.obj.getPath }}" target="_blank"><i class="bi-download"></i></a>
                                {# <a class="kv-file-download btn btn-sm btn-kv btn-default btn-outline-primary" title="Информация по счету" href="/applications/bills/in-work/view/?id={{ bill.obj.getId }}"><i class="bi bi-info-lg"></i></a> #}
                            </td>
                        </tr>
                        {% set fileId = fileId + 1 %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </fieldset>

        {# Скрытый fileinput для инициализации предпросмотра #}
        <div class="d-none">
            <input id="attachments" type="file" name="" multiple="multiple" />
        </div>
    {% else %}
        <p class="text-muted">Нет счетов в работе</p>
    {% endif %}
{% endblock %}

{# Скрипты #}
{% block scripts %}
    <script src="{{ asset('js/fileinput.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('js/fileinput.ru.js') }}" type="text/javascript"></script>
    {% if bills|length > 0 %}
    <script type="text/javascript">
        var params = {
            initialPreview: [
            {% for bill in bills %}
                {% if bill.obj.getFileType == 'image' %}
                    '<img src="{{ url('index') }}upload/bills/{{ bill.obj.getPath }}" class="file-preview-image" alt="" />',
                {% else %}
                    '{{ url('index') }}upload/bills/{{ bill.obj.getPath }}',
                {% endif %}
            {% endfor %}
            ],
            initialPreviewAsData: true,
            hideThumbnailContent: true,
            initialPreviewConfig: [
            {% for bill in bills %}
                {% if bill.obj.getFileType == 'image' %}
                    {type: '{{ bill.obj.getFileType }}', caption: '{{ bill.obj.getFilename }}', downloadUrl: '{{ url('index') }}upload/bills/{{ bill.obj.getPath }}', previewAsData: false},
                {% else %}
                    {type: '{{ bill.obj.getFileType }}', caption: '{{ bill.obj.getFilename }}', downloadUrl: '{{ url('index') }}upload/bills/{{ bill.obj.getPath }}'},
                {% endif %}
            {% endfor %}
            ],
            language: 'ru'
        };
    </script>
    {% endif %}
    <script src="{{ asset('js/bills/print.js') }}" type="text/javascript"></script>

    {% if scripts is defined %}
{{ scripts|raw }}
    {% endif %}
{% endblock %}

{# Стили #}
{% block css %}
{% endblock %}